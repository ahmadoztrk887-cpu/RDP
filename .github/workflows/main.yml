name: SSHX

on:
  workflow_dispatch:

jobs:
  sshx-connection:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Create User Account
        run: |
          $password = "AdminP@ssw0rd123"
          net user admin "$password" /add /Y
          net localgroup Administrators admin /add
          net user admin /expires:never
          
          Write-Host "User created successfully"
          Write-Host "Username: admin"
          Write-Host "Password: $password"

      - name: Download and Run SSHX
        run: |
          # Download SSHX from S3
          $sshxUrl = "https://sshx.s3.amazonaws.com/sshx-x86_64-pc-windows-msvc.zip"
          $zipPath = "$env:TEMP\sshx.zip"
          $extractPath = "$env:TEMP\sshx"
          
          Write-Host "Downloading SSHX from S3..."
          Invoke-WebRequest -Uri $sshxUrl -OutFile $zipPath
          
          Write-Host "Extracting SSHX..."
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          Write-Host "Files in extracted folder:"
          Get-ChildItem $extractPath
          
          # Find the exe file
          $exePath = Get-ChildItem -Path $extractPath -Filter "*.exe" -Recurse | Select-Object -First 1
          
          if ($exePath) {
              Write-Host "`n==================================="
              Write-Host "Starting SSHX..."
              Write-Host "===================================`n"
              
              # Run SSHX and capture output
              $process = Start-Process -FilePath $exePath.FullName -NoNewWindow -PassThru -RedirectStandardOutput "$env:TEMP\sshx_output.txt" -RedirectStandardError "$env:TEMP\sshx_error.txt"
              
              # Wait a bit for SSHX to start and generate URL
              Start-Sleep -Seconds 5
              
              # Display output
              if (Test-Path "$env:TEMP\sshx_output.txt") {
                  Write-Host "SSHX Output:"
                  Get-Content "$env:TEMP\sshx_output.txt"
              }
              
              if (Test-Path "$env:TEMP\sshx_error.txt") {
                  Write-Host "SSHX Error Output:"
                  Get-Content "$env:TEMP\sshx_error.txt"
              }
              
              Write-Host "`nSSHX Process ID: $($process.Id)"
              Write-Host "SSHX is running in background"
          } else {
              Write-Error "SSHX executable not found in extracted files"
              exit 1
          }

      - name: Keep Session Active
        run: |
          Write-Host "`n=== SSHX SESSION ACTIVE ==="
          Write-Host "Username: admin"
          Write-Host "Password: AdminP@ssw0rd123"
          Write-Host "===========================`n"
          
          # Continuously check and display SSHX output
          while ($true) {
              if (Test-Path "$env:TEMP\sshx_output.txt") {
                  $content = Get-Content "$env:TEMP\sshx_output.txt" -Tail 10
                  if ($content) {
                      Write-Host "Latest SSHX Output:"
                      Write-Host $content
                  }
              }
              
              Write-Host "[$(Get-Date)] Session Active - Cancel workflow to terminate"
              Start-Sleep -Seconds 300
          }
