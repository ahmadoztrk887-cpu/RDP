name: SSHX Session

on:
  workflow_dispatch:

jobs:
  sshx-session:
    runs-on: windows-latest
    timeout-minutes: 3600  # 1 saat, gerekirse artır

    steps:
      - name: Download and Extract SSHX
        run: |
          # ZIP'i S3'ten indir
          $sshxUrl = "https://sshx.s3.amazonaws.com/sshx-x86_64-pc-windows-msvc.zip"
          $zipPath = "$env:TEMP\sshx.zip"
          $extractPath = "$env:TEMP\sshx"
          
          Write-Host "SSHX ZIP'ini indiriliyor..."
          Invoke-WebRequest -Uri $sshxUrl -OutFile $zipPath
          
          Write-Host "ZIP çıkarılıyor..."
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          
          Write-Host "Çıkarılmış dosyalar:"
          Get-ChildItem $extractPath -Recurse
          
          # EXE dosyasını bul
          $exePath = Get-ChildItem -Path $extractPath -Filter "*.exe" -Recurse | Select-Object -First 1
          
          if (-not $exePath) {
              Write-Error "EXE dosyası bulunamadı!"
              exit 1
          }
          
          Write-Host "EXE yolu: $($exePath.FullName)"

      - name: Run SSHX and Show Output
        run: |
          $extractPath = "$env:TEMP\sshx"
          $exePath = Get-ChildItem -Path $extractPath -Filter "*.exe" -Recurse | Select-Object -First 1
          
          Write-Host "`n==================================="
          Write-Host "SSHX başlatılıyor..."
          Write-Host "===================================`n"
          
          # SSHX'i çalıştır ve çıktıyı yakala (arka planda değil, doğrudan log'a yaz)
          & $exePath.FullName
          
          # Eğer SSHX arka planda çalışıyorsa, process'i başlat ve bekle
          # (SSHX muhtemelen URL üretip bekler, bu yüzden Start-Process kullan)
          $process = Start-Process -FilePath $exePath.FullName -NoNewWindow -PassThru
          
          # Kısa bekleme ve ilk çıktı kontrolü
          Start-Sleep -Seconds 10
          
          Write-Host "SSHX Process ID: $($process.Id)"
          Write-Host "Çıktı log'larda görünecek (eğer varsa URL paylaşılır)"

      - name: Keep Session Active
        run: |
          Write-Host "`n=== SSHX SESSION AKTİF ==="
          Write-Host "Workflow'u manuel olarak iptal et (Cancel) to terminate."
          Write-Host "SSHX URL'si log'larda görünecek."
          Write-Host "===========================`n"
          
          # Sonsuz döngü ile session'ı tut (her 5 dakikada log güncelle)
          $outputFile = "$env:TEMP\sshx_output.log"
          while ($true) {
              # Sürekli SSHX çıktısını kontrol et ve log'a yaz (eğer dosya varsa)
              if (Test-Path $outputFile) {
                  $latest = Get-Content $outputFile -Tail 5
                  if ($latest) {
                      Write-Host "Son SSHX Çıktısı:"
                      $latest | ForEach-Object { Write-Host $_ }
                  }
              }
              
              Write-Host "[$(Get-Date)] Session aktif - İptal et to close"
              Start-Sleep -Seconds 300  # 5 dakika
          }
